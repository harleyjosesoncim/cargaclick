<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%# Verificação Google opcional via ENV %>
    <% if ENV["GOOGLE_SITE_VERIFICATION"].present? %>
      <meta name="google-site-verification" content="<%= ENV["GOOGLE_SITE_VERIFICATION"] %>">
    <% end %>

    <%# SEO básico com fallback e possibilidade de override por página %>
    <title><%= content_for?(:title) ? yield(:title) : "CargaClick — Simule seu frete agora" %></title>
    <meta name="description" content="<%= content_for?(:meta_description) ? yield(:meta_description) : "Simule fretes, compare transportadores e feche com segurança no CargaClick." %>">
    <meta name="robots" content="<%= Rails.env.production? ? 'index,follow' : 'noindex,nofollow' %>">

    <%# Canonical sem query %>
    <link rel="canonical" href="<%= request.base_url + request.path %>">

    <%# Open Graph / Twitter %>
    <% og_title = content_for?(:og_title) ? yield(:og_title) : "CargaClick — Simule seu frete" %>
    <% og_desc  = content_for?(:og_description) ? yield(:og_description) : "Simule fretes e escolha o melhor transportador." %>
    <% og_image = (image_url('og-image.png') rescue 'https://www.cargaclick.com.br/og-image.png') %>

    <meta property="og:title" content="<%= og_title %>">
    <meta property="og:description" content="<%= og_desc %>">
    <meta property="og:url" content="https://www.cargaclick.com.br/">
    <meta property="og:type" content="website">
    <meta property="og:image" content="<%= og_image %>">
    <meta name="twitter:card" content="summary_large_image">

    <%# JSON-LD com nonce (compatível com CSP padrão do Rails) %>
    <%= tag.script type: "application/ld+json", nonce: content_security_policy_nonce do
      raw({
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "CargaClick",
        "url": "https://www.cargaclick.com.br",
        "logo": og_image
      }.to_json)
    end %>

    <%= tag.script type: "application/ld+json", nonce: content_security_policy_nonce do
      raw({
        "@context": "https://schema.org",
        "@type": "WebSite",
        "url": "https://www.cargaclick.com.br",
        "potentialAction": {
          "@type": "SearchAction",
          "target": "https://www.cargaclick.com.br/busca?q={query}",
          "query-input": "required name=query"
        }
      }.to_json)
    end %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= yield :head %>
  </head>

  <body class="bg-gray-100 min-h-screen font-sans antialiased">
    <header class="bg-white shadow">
      <div class="container mx-auto px-4 py-3 flex items-center gap-4">


        <%# Link Admin: só mostra se rota existir e usuário logado for o admin %>
        <% admin_email = ENV.fetch("ADMIN_EMAIL", "sac.cargaclick@gmail.com") %>
        <% if respond_to?(:current_cliente) &&
              current_cliente&.email&.casecmp?(admin_email) &&
              defined?(admin_dashboard_path) %>
          <%= link_to "Dashboard Admin", admin_dashboard_path, class: "ml-4 text-blue-700 font-semibold" %>
        <% end %>
      </div>
    </header>

    <div class="container mx-auto px-4 mt-4">
      <% flash.each do |type, msg| %>
        <div class="mb-3 rounded-lg px-4 py-3 <%= type.to_s == 'alert' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800' %>">
          <%= msg %>
        </div>
      <% end %>
    </div>

    <main class="container mx-auto px-4 py-8">
      <%= yield %>
    </main>

    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
    <%= yield :before_body_end %>
  </body>
</html>

