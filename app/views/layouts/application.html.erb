<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- =====================================================
         THEME / UX BÁSICO
         Não quebra se dark/light falhar
         ===================================================== -->
    <meta name="theme-color" content="#0b132b" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">

    <!-- =====================================================
         SEO GLOBAL + DINÂMICO (COM FALLBACK TOTAL)
         ===================================================== -->
    <% page_title = @page_title.presence ||
                    content_for?(:title) && yield(:title) ||
                    "CargaClick – Fretes simples, rápidos e sem atrito" %>

    <% meta_description = @meta_description.presence ||
                          content_for?(:description) && yield(:description) ||
                          "Conectamos clientes e transportadores para fretes sob demanda, com transparência e sem burocracia." %>

    <title><%= page_title %></title>
    <meta name="description" content="<%= meta_description %>">

    <!-- Open Graph / Social -->
    <meta property="og:title"       content="<%= page_title %>">
    <meta property="og:description" content="<%= meta_description %>">
    <meta property="og:type"        content="website">
    <meta property="og:url"         content="<%= request.original_url %>">
    <meta property="og:image"       content="<%= asset_path('cargaclick_og.png') %>">

    <!-- Canonical -->
    <link rel="canonical" href="<%= request.original_url %>">

    <!-- =====================================================
         SEGURANÇA
         ===================================================== -->
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- =====================================================
         ASSETS OPCIONAIS (Leaflet nunca pode quebrar)
         ===================================================== -->
    <% begin %>
      <meta name="leaflet-icon"    content="<%= asset_path('marker-icon.png') %>">
      <meta name="leaflet-icon-2x" content="<%= asset_path('marker-icon-2x.png') %>">
      <meta name="leaflet-shadow"  content="<%= asset_path('marker-shadow.png') %>">
    <% rescue %>
      <%# Assets ausentes → ignorado com segurança %>
    <% end %>

    <!-- =====================================================
         CSS (ordem segura)
         ===================================================== -->
    <%= stylesheet_link_tag "leaflet",      "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "tailwind", "inter-font", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>

    <!-- =====================================================
         JS (defer obrigatório – UI não depende dele)
         ===================================================== -->
    <%= javascript_include_tag "application",
          "data-turbo-track": "reload",
          defer: true %>

    <!-- HEAD EXTRA POR VIEW -->
    <%= yield :head %>
  </head>

  <body class="min-h-screen flex flex-col bg-gray-100 dark:bg-gray-900 font-sans antialiased">

    <!-- =====================================================
         NAVBAR (OPCIONAL / NÃO BLOQUEANTE)
         ===================================================== -->
    <% if lookup_context.exists?("layouts/navbar") %>
      <header role="banner">
        <%= render "layouts/navbar" %>
      </header>
    <% end %>

    <!-- =====================================================
         FLASH MESSAGES (NÃO BLOQUEIAM UI)
         ===================================================== -->
    <% if lookup_context.exists?("shared/flash") %>
      <section class="w-full px-4 mt-4 md:container md:mx-auto">
        <%= render "shared/flash" %>
      </section>
    <% end %>

    <!-- =====================================================
         CONTEÚDO PRINCIPAL
         ===================================================== -->
    <main role="main"
          class="flex-1 w-full px-4 pt-24 pb-8 md:container md:mx-auto">

      <% if content_for?(:content) %>
        <%= yield :content %>
      <% else %>
        <%= yield %>
      <% end %>

      <!-- FALLBACK SMOKE -->
      <% if !content_for?(:content) && view_flow.get(:layout).blank? %>
        <div class="text-center text-sm text-gray-400 mt-12">
          Página carregada sem conteúdo específico.
        </div>
      <% end %>

    </main>

    <!-- =====================================================
         FOOTER (OPCIONAL)
         ===================================================== -->
    <% if lookup_context.exists?("layouts/footer") %>
      <footer role="contentinfo">
        <%= render "layouts/footer" %>
      </footer>
    <% end %>

    <!-- =====================================================
         JS EXTRA POR VIEW
         ===================================================== -->
    <%= yield :body_end %>

  </body>
</html>
