<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
  <head>
    <!-- =====================================================
         META BÁSICO
         ===================================================== -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- =====================================================
         THEME / UX (fallback seguro)
         ===================================================== -->
    <meta name="theme-color" content="#0b132b" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">

    <!-- =====================================================
         SEO DINÂMICO COM FALLBACK
         ===================================================== -->
    <% page_title =
        @page_title.presence ||
        (content_for?(:title) ? yield(:title) : nil) ||
        "CargaClick – Fretes rápidos, simples e sem burocracia" %>

    <% meta_description =
        @meta_description.presence ||
        (content_for?(:description) ? yield(:description) : nil) ||
        "Conectamos clientes e transportadores para fretes sob demanda, com transparência, agilidade e zero atrito." %>

    <title><%= page_title %></title>
    <meta name="description" content="<%= meta_description %>">

    <!-- =====================================================
         OPEN GRAPH / SOCIAL
         ===================================================== -->
    <meta property="og:title" content="<%= page_title %>">
    <meta property="og:description" content="<%= meta_description %>">
    <meta property="og:type" content="website">
    <meta property="og:url" content="<%= request.original_url %>">
    <meta property="og:image" content="<%= asset_path('cargaclick_og.png') rescue '' %>">

    <!-- =====================================================
         CANONICAL
         ===================================================== -->
    <link rel="canonical" href="<%= request.original_url %>">

    <!-- =====================================================
         SEGURANÇA
         ===================================================== -->
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- =====================================================
         LEAFLET (NUNCA QUEBRA A VIEW)
         ===================================================== -->
    <% begin %>
      <meta name="leaflet-icon" content="<%= asset_path('marker-icon.png') %>">
      <meta name="leaflet-icon-2x" content="<%= asset_path('marker-icon-2x.png') %>">
      <meta name="leaflet-shadow" content="<%= asset_path('marker-shadow.png') %>">
    <% rescue %>
      <%# Assets ausentes → ignora silenciosamente %>
    <% end %>

    <!-- =====================================================
         CSS (ordem segura)
         ===================================================== -->
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "leaflet", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>

    <!-- =====================================================
         JS (defer – UI não depende de JS)
         ===================================================== -->
    <%= javascript_include_tag "application",
          defer: true,
          "data-turbo-track": "reload" %>

    <!-- HEAD EXTRA POR VIEW -->
    <%= yield :head %>
  </head>

  <body class="h-full min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 antialiased">

    <!-- =====================================================
         NAVBAR (opcional e segura)
         ===================================================== -->
    <% if lookup_context.exists?("layouts/navbar") %>
      <header class="fixed top-0 left-0 w-full z-50">
        <%= render "layouts/navbar" %>
      </header>
    <% end %>

    <!-- =====================================================
         FLASH MESSAGES (não bloqueantes)
         ===================================================== -->
    <% if lookup_context.exists?("shared/flash") %>
      <section class="pt-24 px-4 md:container md:mx-auto">
        <%= render "shared/flash" %>
      </section>
    <% end %>

    <!-- =====================================================
         CONTEÚDO PRINCIPAL
         ===================================================== -->
    <main role="main"
          class="flex-1 w-full pt-28 pb-12 px-4 md:container md:mx-auto">

      <% if content_for?(:content) %>
        <%= yield :content %>
      <% else %>
        <%= yield %>
      <% end %>

      <!-- Smoke / fallback seguro -->
      <% if !content_for?(:content) && view_flow.get(:layout).blank? %>
        <div class="mt-16 text-center text-sm text-gray-400">
          Página carregada com sucesso.
        </div>
      <% end %>

    </main>

    <!-- =====================================================
         FOOTER (opcional)
         ===================================================== -->
    <% if lookup_context.exists?("layouts/footer") %>
      <footer class="bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
        <%= render "layouts/footer" %>
      </footer>
    <% end %>

    <!-- =====================================================
         JS EXTRA POR VIEW
         ===================================================== -->
    <%= yield :body_end %>

  </body>
</html>
