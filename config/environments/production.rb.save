# config/environments/production.rb
# frozen_string_literal: true

Rails.application.configure do
config.force_ssl = false
config.public_file_server.enabled = ENV['RAILS_SERVE_STATIC_FILES'].present?
config.log_level = :info

  # ============================================================
  # AMBIENTE: PRODUÇÃO
  # ============================================================
  config.cache_classes = true
  config.eager_load    = true
  config.consider_all_requests_local = false
  config.action_view.cache_template_loading = true

  # Exigir master key em runtime; permite pular apenas no build de assets
  # use no build: SKIP_MASTER_KEY=1 bundle exec rake assets:precompile
  config.require_master_key = ENV["SKIP_MASTER_KEY"] != "1"

  # ============================================================
  # HOSTS & SSL
  # ============================================================
  app_host = ENV["APP_HOST"]
  config.hosts << app_host if app_host.present?
  config.hosts << "www.cargaclick.com.br"
  config.hosts << /.*\.onrender\.com/
  config.hosts << "localhost"
  config.hosts << "127.0.0.1"
  config.hosts << "::1"

  config.force_ssl = ActiveModel::Type::Boolean.new.cast(ENV.fetch("FORCE_SSL", "true"))
  config.ssl_options = { hsts: { expires: 1.year, subdomains: true, preload: true } }
  config.action_controller.forgery_protection_origin_check = true

  # Geração de URLs fora do mailer (ex: redirects/background jobs)
  default_host  = ENV.fetch("APP_HOST", "www.cargaclick.com.br")
  default_proto = ENV.fetch("APP_PROTOCOL", "https")
  routes.default_url_options = { host: default_host, protocol: default_proto }

  # ============================================================
  # MIDDLEWARE DE PERFORMANCE
  # ============================================================
  # Compressão Gzip para respostas textuais (HTML/JSON/CSS/JS)
  config.middleware.use Rack::Deflater

  # ============================================================
  # CACHE & ARQUIVOS ESTÁTICOS
  # ============================================================
  config.action_controller.perform_caching = true
  config.action_controller.enable_fragment_cache_logging = false

  # Servir assets estáticos (Render define RAILS_SERVE_STATIC_FILES=true)
  config.public_file_server.enabled = ENV["RAILS_SERVE_STATIC_FILES"].present?
  config.public_file_server.headers = {
    "Cache-Control" => "public, max-age=31536000, immutable"
  }

  # Cache store com Redis e fallback seguro
  redis_url = ENV["REDIS_URL"].presence
  if redis_url && !redis_url.include?("redis://host:6379")
    config.cache_store = :redis_cache_store, {
      url: redis_url,
      connect_timeout: 5, read_timeout: 1, write_timeout: 1,
      reconnect_attempts: 3,
      error_handler: ->(method:, returning:, exception:) {
        # Evite Rails.logger no precompile
        STDERR.puts "Redis cache error: #{method} returning=#{returning} #{exception.class}: #{exception.message}"
      }
      # Para prr com TLS (rediss://), opcional:
      # ssl_params: { verify_mode: OpenSSL::SSL::VERIFY_NONE }
    }
  else
    STDERR.puts "[warn] REDIS_URL ausente; usando :memory_store (adequado só para 1 instância)"
    config.cache_store = :memory_store, { size: 128.megabytes }
  end

  # ============================================================
  # ASSETS
  # ===========          ENV["SMTP_PASSWORD"],
    domain:               ENV.fetch("SMTP_DOMAIN", "cargaclick.com.br"),
    authentication:       ENV.fetch("SMTP_AUTH", "plain"),
    enable_starttls_auto: ENV.fetch("SMTP_ENABLE_STARTTLS_AUTO", "true") == "true",
    open_timeout:         ENV.fetch("SMTP_OPEN_TIMEOUT", 5).to_i,
    read_timeout:         ENV.fetch("SMTP_READ_TIMEOUT", 5).to_i
  }

  config.action_mailer.default_url_options = {
    host:     default_host,
    protocol: default_proto
  }
  config.action_mailer.asset_host = "#{default_proto}://#{default_host}"
  config.action_mailer.default_options = {
    from: ENV.fetch("MAILER_SENDER", "no-reply@cargaclick.com.br")
  }

  # ===========
