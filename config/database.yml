# config/database.yml
default: &default
  adapter: postgresql
  encoding: unicode
  # Pool = WEB_CONCURRENCY * RAILS_MAX_THREADS + 2 (fallback 2*5+2=12)
  pool: <%= ENV.fetch("DB_POOL") { (ENV.fetch("WEB_CONCURRENCY", "2").to_i * ENV.fetch("RAILS_MAX_THREADS", "5").to_i + 2) } %>
  checkout_timeout: <%= ENV.fetch("DB_CHECKOUT_TIMEOUT", "5") %>
  variables:
    statement_timeout: <%= ENV.fetch("DB_STATEMENT_TIMEOUT_MS", "15000") %>
    lock_timeout: <%= ENV.fetch("DB_LOCK_TIMEOUT_MS", "5000") %>

development:
  <<: *default
  # Usa DATABASE_URL se existir; senão Postgres local
  url: <%= ENV["DATABASE_URL"] || "postgres://postgres:postgres@localhost:5432/cargaclick_development" %>

test:
  <<: *default
  url: <%= ENV["DATABASE_URL"] || "postgres://postgres:postgres@localhost:5432/cargaclick_test" %>

production:
  <<: *default
  # Em produção (Render), defina DATABASE_URL no painel (com ?sslmode=require).
  # Localmente, se não houver, cai para Postgres local para não quebrar.
  url: <%= ENV["DATABASE_URL"] || ENV["RENDER_DATABASE_URL"] || "postgres://postgres:postgres@localhost:5432/cargaclick_production" %>
  reaping_frequency: <%= ENV.fetch("DB_REAPING_FREQUENCY", "10") %>
  prepared_statements: <%= ENV.fetch("DB_PREPARED_STATEMENTS", "true") == "true" %>

  
